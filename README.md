# Beat Diffusion - ビートマニア風音楽ゲーム

MP4動画とMP3音楽に合わせて6キー（A,S,D,G,H,J）で遊ぶビートマニア風の音楽ゲームです。

## 機能

- **楽曲選択システム**: 事前に設定された楽曲から選択してプレイ
- **メインゲーム**: MP3音楽とMP4動画を背景にした本格的な音楽ゲーム
- **難易度選択**: Easy/Normal/Hard/Extreme の4つの難易度
- **プレビュー機能**: 楽曲の一部を事前に試聴可能
- **譜面制作システム**: スペースキー押下でタイムスタンプを記録する簡単な譜面制作
- **譜面自動生成**: 生データから4つの難易度の譜面を自動生成
- **判定システム**: Perfect/Good/Poor/Miss の4段階判定とコンボシステム
- **スコアリング**: コンボボーナス付きスコアシステム

## セットアップ

1. 依存関係をインストール:
```bash
npm install
```

2. 開発サーバー起動:
```bash
npm run dev
```

3. ブラウザで `http://localhost:3000` にアクセス

## アセットの準備

ゲームを楽しむには、まず楽曲ファイルを準備する必要があります：

1. `assets/audio/` フォルダにMP3ファイルを配置
2. `assets/video/` フォルダにMP4ファイルを配置（オプション）
3. `assets/images/` フォルダにジャケット画像を配置（オプション）
4. `songs.json` に楽曲情報を追加

## 効率的な楽曲管理方法

**最も効率的**: `songs.json`で楽曲情報を一元管理

### 楽曲追加の手順
1. アセットファイルを配置
2. `songs.json`に楽曲情報を追加
3. コード変更なしで即座に反映

### songs.json設定例
```json
{
  "id": "your_song",
  "displayName": "表示用楽曲名",
  "artistDisplayName": "表示用アーティスト名",
  "genre": "Electronic", 
  "year": 2024,
  "description": "楽曲の説明文",
  "backgroundVideo": "assets/video/your_song.mov",
  "color": {
    "primary": "#ff6b9d",
    "secondary": "#a8e6cf", 
    "accent": "#ffd93d"
  },
  "ui": {
    "showBackgroundVideo": true,
    "showPreviewOnHover": true
  }
}
```

### 設定可能項目
- **基本情報**: 楽曲名、アーティスト、ジャンル、年
- **表示設定**: カスタムカラー、背景動画、アニメーション
- **プレビュー**: ホバー時の動画再生、開始時間
- **UI制御**: カードサイズ、表示効果

詳細は `assets/README.md` を参照してください。

## 使い方

### メインゲーム

1. トップ画面で楽曲を選択
2. 楽曲詳細画面で難易度を選択（Easy/Normal/Hard/Extreme）
3. 「プレビュー」で楽曲の一部を試聴可能
4. 「ゲーム開始」でプレイ開始
5. A,S,D,G,H,Jキーでプレイ
6. Escキーでメニューに戻る

### 譜面制作システム

1. トップ画面で「譜面制作」をクリック
2. 音楽ファイル（.mp3）を読み込み
3. 楽曲名を入力
4. 「記録開始」で音楽再生が始まるので、リズムに合わせてスペースキーを押下
5. 「記録停止」で記録終了
6. **プレビュー機能**: 「プレビュー」ボタンで楽曲再生中にタイムスタンプがリアルタイムでハイライト
7. **タイムスタンプ編集**: 各タイムスタンプで「編集」「削除」「移動」が可能
8. 「譜面生成」で4つの難易度の譜面を自動生成
9. 各譜面を保存またはテストプレイ可能

#### プレビュー機能詳細
- **🟢 緑色**: 現在再生中のタイムスタンプ（パルスアニメーション）
- **🟡 黄色**: 間もなく来るタイムスタンプ（2秒以内）
- **🔵 青色**: 最近通過したタイムスタンプ（1秒以内）
- **🟣 紫色**: 「移動」ボタンで選択したタイムスタンプ

#### タイムスタンプ操作
- **編集**: タイムスタンプの時間を数値で微調整
- **削除**: 不要なタイムスタンプを削除
- **移動**: 該当時間に音楽を移動して確認

#### 譜面生成システム詳細
スペースキーで記録したタイムスタンプから、4つの難易度の譜面を自動生成：

| 難易度 | 使用率 | 同時押し率 | 最大同時数 | 最小間隔 | 特徴 |
|--------|--------|------------|------------|----------|------|
| **Easy** | 40% | 0% | 1キー | 600ms | 単発ノーツのみ、ゆったり |
| **Normal** | 70% | 15% | 2キー | 350ms | 2キー同時押し導入 |
| **Hard** | 90% | 30% | 3キー | 200ms | 3キー同時押し、高密度 |
| **Extreme** | 100% | 45% | 3キー | 100ms | 最高密度、複雑パターン |

#### 同時押しパターン
**2キー同時押し**: 隣接・1つ飛ばし・両端など自然なパターン  
**3キー同時押し**: 連続3個・交互配置・混合パターンなど音楽的配置

#### 生成譜面の詳細表示
- **統計情報**: 総ノーツ数・同時押し数・密度（ノーツ/秒）
- **レーン使用率**: A,S,D,G,H,J各キーの使用頻度をバーチャート表示
- **プレビュー**: 最初の10秒間のノーツパターンを確認

## ファイル構成

```
beat-diffusion/
├── assets/            # ゲームアセット
│   ├── audio/         # 音楽ファイル（.mp3）
│   ├── video/         # 動画ファイル（.mp4）
│   ├── chart/         # 譜面ファイル（.json）
│   ├── images/        # ジャケット画像
│   └── README.md      # アセット配置方法
├── index.html          # メインゲーム画面
├── chart-editor.html   # 譜面制作システム
├── songs.json         # 楽曲設定ファイル
├── style.css          # スタイルシート
├── app.js             # メインアプリケーション制御
├── game.js            # ゲームエンジン（Canvas 2D）
├── chart-editor.js    # 譜面制作システム
├── chart-generator.js # 譜面自動生成システム
├── package.json       # プロジェクト設定
└── README.md          # このファイル
```

## 技術仕様

- **フロントエンド**: Vanilla JavaScript + Canvas API
- **音楽**: Web Audio API
- **動画**: HTML5 Video API
- **ファイル形式**: MP3（音楽）, MP4（動画）, JSON（譜面）
- **キー**: 6キー（A,S,D,G,H,J）
- **フレームレート**: 60fps目標

## 難易度設定

| 難易度 | ノーツ割合 | 同時押し確率 | 最大同時数 | 最小間隔 |
|--------|------------|--------------|------------|----------|
| Easy   | 30%        | 0%           | 1          | 0.5秒    |
| Normal | 60%        | 10%          | 2          | 0.25秒   |
| Hard   | 80%        | 25%          | 3          | 0.15秒   |
| Extreme| 100%       | 40%          | 4          | 0.1秒    |

## 判定システム

| 判定 | タイミング窓 | スコア倍率 |
|------|--------------|------------|
| Perfect | ±50ms     | 1000pt     |
| Good    | ±100ms    | 500pt      |
| Poor    | ±150ms    | 100pt      |
| Miss    | ±200ms    | 0pt        |

コンボ10回毎に100ptのボーナス

## カスタマイズ

### 判定タイミングの調整
`game.js` の `judgmentTimings` オブジェクトを編集

### 難易度パラメータの調整
`chart-generator.js` の `difficulties` オブジェクトを編集

### スタイルの変更
`style.css` を編集

## 既知の制限

- Webブラウザのセキュリティポリシーにより、ローカルファイルアクセスには制限があります
- 一部のブラウザでは音楽と動画の同期にズレが生じる場合があります
- 大容量の動画ファイルはメモリ使用量が増加する可能性があります

## ライセンス

MIT License