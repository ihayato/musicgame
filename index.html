<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-POP Beat</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <!-- OGP Meta Tags -->
    <meta property="og:title" content="AI-POP Beat">
    <meta property="og:description" content="AIポップメロディに合わせて鍵盤を叩く音楽ゲーム。6楽曲収録、難易度選択可能！">
    <meta property="og:image" content="https://otogame2.vercel.app/ogp.png">
    <meta property="og:url" content="https://otogame2.vercel.app/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="AI-POP Beat">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI-POP Beat">
    <meta name="twitter:description" content="AIポップメロディに合わせて鍵盤を叩く音楽ゲーム。6楽曲収録、難易度選択可能！">
    <meta name="twitter:image" content="https://otogame2.vercel.app/ogp.png">
    
    <!-- Additional Meta -->
    <meta name="description" content="AI-POP Beat - AIポップリズムゲーム。6楽曲収録、リアルタイム譜面エディタ機能付き。">
    <meta name="keywords" content="音楽ゲーム,リズムゲーム,AI-POP Beat,AIポップ,譜面エディタ">
    <meta name="author" content="AI-POP Beat Team">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- グローバルメニュー -->
    <div class="global-menu">
        <a href="submit.html" class="menu-link">楽曲を投稿する</a>
    </div>
    
    <div id="app">
        <div id="menu" class="screen active">
            <h1>AI-POP Beat</h1>
            <p class="game-catchphrase">全曲ミュージックビデオ付き。新しいポップカルチャー「AI-POP」を音ゲーで楽しもう！PCキーボードでお楽しみください</p>
            <div id="songSelection" class="selection-step active">
                <h2>楽曲選択</h2>
                <div id="songList" class="song-list"></div>
            </div>
            
            <div id="difficultySelection" class="selection-step">
                <div id="selectedSongDisplay">
                    <div id="songBanner">
                        <video id="bannerVideo" muted loop preload="metadata"></video>
                        <div class="banner-overlay"></div>
                        <div class="banner-content">
                            <h2 id="bannerSongTitle"></h2>
                            <p id="bannerSongArtist"></p>
                            <div class="banner-stats">
                                <span id="bannerDuration"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="difficulty-grid">
                    <h3>難易度を選択してください</h3>
                    <div class="difficulty-cards">
                        <div class="difficulty-card" data-difficulty="easy">
                            <div class="difficulty-name">EASY</div>
                            <div class="difficulty-description">初心者向け</div>
                        </div>
                        <div class="difficulty-card" data-difficulty="normal">
                            <div class="difficulty-name">NORMAL</div>
                            <div class="difficulty-description">基本レベル</div>
                        </div>
                        <div class="difficulty-card" data-difficulty="hard">
                            <div class="difficulty-name">HARD</div>
                            <div class="difficulty-description">上級者向け</div>
                        </div>
                        <div class="difficulty-card" data-difficulty="extreme">
                            <div class="difficulty-name">EXTREME</div>
                            <div class="difficulty-description">最高難易度</div>
                        </div>
                    </div>
                </div>
                
                <div class="selection-controls">
                    <button id="backToSongBtn" class="control-btn back-btn">楽曲選択に戻る</button>
                    <button id="startGameBtn" class="control-btn start-btn" disabled>ゲーム開始</button>
                </div>
            </div>
        </div>

        <div id="game" class="screen">
            <video id="bgVideo" muted tabindex="-1" playsinline disablePictureInPicture preload="auto"></video>
            <canvas id="gameCanvas"></canvas>
            <audio id="gameAudio"></audio>
            
            <div id="gameUI">
                <div id="score">Score: 0</div>
                <div id="combo">Combo: 0</div>
            </div>
            
            <div id="judgment"></div>
            
            <div id="keys">
                <div class="key" data-key="A">A</div>
                <div class="key" data-key="S">S</div>
                <div class="key" data-key="D">D</div>
                <div class="key" data-key="F">F</div>
                <div class="key" data-key="G">G</div>
                <div class="key" data-key="H">H</div>
            </div>
            
            <button id="backToMenu">メニューに戻る</button>
        </div>
    </div>

    <!-- Game Clear Screen -->
    <div id="gameClear" class="screen">
        <div class="clear-content">
            <div class="clear-title">
                <h1>GAME CLEAR!</h1>
            </div>
            
            <div class="clear-results">
                <div class="score-display">
                    <div class="score-item">
                        <span class="score-label">SCORE</span>
                        <span id="finalScore" class="score-value">0</span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">MAX COMBO</span>
                        <span id="finalMaxCombo" class="score-value">0</span>
                    </div>
                </div>
                
                <div class="judgment-stats">
                    <div class="judgment-row perfect">
                        <span class="judgment-label">PERFECT</span>
                        <span id="perfectCount" class="judgment-count">0</span>
                    </div>
                    <div class="judgment-row good">
                        <span class="judgment-label">GOOD</span>
                        <span id="goodCount" class="judgment-count">0</span>
                    </div>
                    <div class="judgment-row poor">
                        <span class="judgment-label">POOR</span>
                        <span id="poorCount" class="judgment-count">0</span>
                    </div>
                    <div class="judgment-row miss">
                        <span class="judgment-label">MISS</span>
                        <span id="missCount" class="judgment-count">0</span>
                    </div>
                </div>
                
                <div class="accuracy-display">
                    <span class="accuracy-label">ACCURACY</span>
                    <span id="finalAccuracy" class="accuracy-value">0.00%</span>
                </div>
            </div>
            
            <div class="clear-controls">
                <button id="retryBtn" class="clear-btn retry-btn">もう一度</button>
                <button id="backToEditorBtn" class="clear-btn editor-btn" style="display: none;">譜面エディタに戻る</button>
                <button id="backToMenuFromClear" class="clear-btn menu-btn">メニューに戻る</button>
            </div>
        </div>
        
        <!-- Clear audio effect -->
        <audio id="clearAudio" preload="auto">
            <source src="gameclear.mp3" type="audio/mpeg">
        </audio>
    </div>

    <!-- YouTube Popup -->
    <div id="youtubePopup" class="youtube-popup" style="display: none;">
        <div class="youtube-popup-overlay"></div>
        <div class="youtube-popup-content">
            <button class="youtube-popup-close" id="youtubePopupClose">❌</button>
            <h3 class="youtube-popup-title">YouTubeで高画質・高音質版を視聴する</h3>
            <div class="youtube-popup-video">
                <iframe id="youtubeIframe" 
                        width="560" 
                        height="315" 
                        src="" 
                        title="YouTube video player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        allowfullscreen>
                </iframe>
            </div>
            <div class="youtube-popup-actions">
                <button class="youtube-popup-btn primary" id="youtubePopupWatch">YouTubeで視聴</button>
                <button class="youtube-popup-btn secondary" id="youtubePopupLater">後で見る</button>
            </div>
        </div>
    </div>

    <script src="game.js"></script>
    <script src="chart-generator.js"></script>
    <script src="app.js"></script>
    <script>
        // Auto-initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            
            // Simple initialization with error handling
            try {
                if (!window.app) {
                    window.app = new App();
                    console.log('App instance created successfully');
                }
            } catch (error) {
                console.error('Failed to initialize app:', error);
                
                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                background: rgba(0,0,0,0.9); color: white; padding: 20px; border-radius: 10px; 
                                text-align: center; z-index: 10000;">
                        <h3>アプリの初期化に失敗しました</h3>
                        <p>ページをリロードしてください</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px;">リロード</button>
                    </div>
                `;
                document.body.appendChild(errorDiv);
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (window.app && window.app.game) {
                try {
                    window.app.game.stop();
                } catch (e) {
                    console.warn('Error during cleanup:', e);
                }
            }
        });
    </script>
</body>
</html>